<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presenter View - SlideChangerOnline</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        #presenter-container {
            width: 100%;
            max-width: 1200px;
            margin: 2rem auto;
            background-color: #1f2937;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            aspect-ratio: 16 / 9;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        #pdf-container {
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        #pdf-canvas {
            border-radius: 0.25rem;
            /* NEW: Added for smooth page transitions */
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-200">
    <div id="presenter-container">
        <div id="loading-message" class="flex flex-col items-center justify-center h-full text-white">
            <svg class="animate-spin h-10 w-10 text-white mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-xl">Loading presentation...</p>
        </div>

        <div id="error-message" class="hidden flex-col items-center justify-center h-full">
             <p class="text-xl text-red-400">Could not load presentation. It may have expired or the link is invalid.</p>
        </div>
        
        <div id="pdf-container" class="hidden flex-grow items-center justify-center">
            <canvas id="pdf-canvas"></canvas>
        </div>
         <button id="fullscreen-btn" class="absolute bottom-4 right-4 bg-gray-900 bg-opacity-50 hover:bg-opacity-75 text-white font-bold p-3 rounded-full transition duration-300">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>
        </button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
  apiKey: "AIzaSyCtlgsNhCEsKLHA-WmfoqQleW_n2kCQerI",
  authDomain: "slidechangeronline.firebaseapp.com",
  projectId: "slidechangeronline",
  storageBucket: "slidechangeronline.firebasestorage.app",
  messagingSenderId: "1013262596418",
  appId: "1:1013262596418:web:b7c9ee7e6da7545ff370db"
};

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const loadingMessage = document.getElementById('loading-message');
        const errorMessage = document.getElementById('error-message');
        const pdfContainer = document.getElementById('pdf-container');
        const canvas = document.getElementById('pdf-canvas');
        const ctx = canvas.getContext('2d');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const presenterContainer = document.getElementById('presenter-container');
        
        let pdfDoc = null;
        let pageNum = 1;
        let isRendering = false; // Prevent multiple renders at once

        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;

        function renderPage(num) {
            if (!pdfDoc || isRendering) return;
            isRendering = true;

            // Fade out for transition
            canvas.style.opacity = 0;

            setTimeout(() => { // Allow fade-out to happen
                pdfDoc.getPage(num).then(function(page) {
                    const container = presenterContainer;
                    const viewport = page.getViewport({ scale: 1 });
                    const scale = Math.min(container.clientHeight / viewport.height, container.clientWidth / viewport.width) * 0.98;
                    const scaledViewport = page.getViewport({ scale: scale });
                    const devicePixelRatio = window.devicePixelRatio || 1;

                    canvas.width = Math.floor(scaledViewport.width * devicePixelRatio);
                    canvas.height = Math.floor(scaledViewport.height * devicePixelRatio);
                    canvas.style.width = `${Math.floor(scaledViewport.width)}px`;
                    canvas.style.height = `${Math.floor(scaledViewport.height)}px`;
                    
                    const renderContext = {
                        canvasContext: ctx,
                        viewport: scaledViewport,
                        transform: [devicePixelRatio, 0, 0, devicePixelRatio, 0, 0]
                    };
                    
                    const renderTask = page.render(renderContext);
                    renderTask.promise.then(() => {
                        // Fade in new page
                        canvas.style.opacity = 1;

                        // *** NEW: Generate preview for remote ***
                        // Use a short delay to ensure the canvas is painted
                        setTimeout(() => {
                            const previewImage = canvas.toDataURL('image/jpeg', 0.4); // Low quality for speed
                            const docRef = doc(db, "presentations", presentationId);
                            updateDoc(docRef, { previewImage: previewImage });
                        }, 100);

                        isRendering = false;
                    });
                });
            }, 300); // Match CSS transition time
            pageNum = num;
        }
        
        // Main logic
        const params = new URLSearchParams(window.location.search);
        const presentationId = params.get('id');

        if (presentationId) {
            const docRef = doc(db, "presentations", presentationId);

            const unsubscribe = onSnapshot(docRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    
                    if (!pdfDoc) {
                        const url = data.fileUrl;
                        const loadingTask = pdfjsLib.getDocument(url);
                        loadingTask.promise.then(function(pdfDoc_) {
                            pdfDoc = pdfDoc_;
                            
                            const totalPages = pdfDoc.numPages;
                            updateDoc(docRef, { totalPages: totalPages })
                                .catch(err => console.error("Could not update total pages:", err));
                            
                            loadingMessage.classList.add('hidden');
                            pdfContainer.classList.remove('hidden');
                            renderPage(data.currentPage);
                        }, function (reason) {
                            console.error("Error loading PDF:", reason);
                            loadingMessage.classList.add('hidden');
                            errorMessage.classList.remove('hidden');
                        });
                    }

                    if (pageNum !== data.currentPage) {
                        renderPage(data.currentPage);
                    }
                } else {
                    console.error("No such document!");
                    loadingMessage.classList.add('hidden');
                    errorMessage.classList.remove('hidden');
                    unsubscribe();
                }
            }, (error) => {
                console.error("Error getting document:", error);
                loadingMessage.classList.add('hidden');
                errorMessage.classList.remove('hidden');
            });
        } else {
            loadingMessage.classList.add('hidden');
            errorMessage.classList.remove('hidden');
        }

        fullscreenBtn.addEventListener('click', () => {
            if (!document.fullscreenElement) {
                presenterContainer.requestFullscreen().catch(err => {
                    alert(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
                });
            } else {
                document.exitFullscreen();
            }
        });

        window.addEventListener('resize', () => {
             if (pdfDoc) {
                renderPage(pageNum);
            }
        });

        document.addEventListener('fullscreenchange', () => {
            setTimeout(() => {
                if (pdfDoc) {
                    renderPage(pageNum);
                }
            }, 100);
        });
    </script>
</body>
</html>

